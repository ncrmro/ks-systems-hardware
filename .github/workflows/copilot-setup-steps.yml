name: 'Copilot Setup Steps'

# IMPORTANT: When making changes to this workflow, update the conventions documentation:
# docs/conventions/copilot-agent.md

# Automatically run the setup steps when they are changed to allow for easy validation, and
# allow manual testing through the repository's "Actions" tab
on:
  workflow_dispatch:
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # Note: Environment variables defined here are only available during the setup steps.
    # They do NOT automatically transfer to the Copilot environment.
    # To make them available to Copilot, append them to .env file in the steps below.
    #
    # GitHub Actions context variable (automatically set by GitHub Actions):
    # - github.job = "copilot-setup-steps" when running via PR or workflow_dispatch
    # - github.job = "copilot" when running during Copilot agent execution
    #
    # We use github.job in conditionals to control execution:
    # - Setup mode (github.job=copilot-setup-steps): Run setup + verification
    #   to verify the environment is working correctly before Copilot uses it
    # - Copilot mode (github.job=copilot): Skip verification since the
    #   environment was already verified during setup steps
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    # Set the permissions to the lowest permissions possible needed for your steps.
    # Copilot will be given its own token for its operations.
    permissions:
      contents: read

    # You can define any steps you want, and they will run before the agent starts.
    # If you do not check out your code, Copilot will do this for you.
    steps:
      - name: Validate GITHUB_JOB
        run: |
          echo "GITHUB_JOB=$GITHUB_JOB"
          echo "github.job=${{ github.job }}"
          echo "github.event_name=${{ github.event_name }}"

      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Environment
        run: |
          # Create .venv and install dependencies using the flake's tools
          nix develop --command bash -c "uv venv && uv sync"

      - name: Verify (Render)
        if: github.job == 'copilot-setup-steps'
        run: |
          # Run render to verify the environment and tools (OpenSCAD + Python) are working
          nix develop --command ./bin/render
